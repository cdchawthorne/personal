#!/usr/bin/env zsh

if [[ "$(whoami)" != root ]]; then
    echo 'ERROR: must be run as root' 1>&2
    exit 1
fi

if [[ $# -ne 2 ]]; then
    echo "usage: $0 SSID CONF_FILE"
    exit 1
fi

WPA_OUTFILE="$(mktemp)"
INTERFACE=wlp0s20u2
# INTERFACE=wlp0s20u1
# INTERFACE=wlp3s0b1

function kill_things {
    dhclient -x &> /dev/null
    killall wpa_supplicant &> /dev/null
    return 0
}

function TRAPINT { ip link set dev ${INTERFACE} down; return $((128 + $1)) }

while true; do
    : > ${WPA_OUTFILE}
    ip link set dev ${INTERFACE} down
    sleep 0.5
    ip link set dev ${INTERFACE} up
    iw dev ${INTERFACE} connect $1
    wpa_supplicant -i${INTERFACE} -c$2 -f ${WPA_OUTFILE} &
    until grep -E "^${INTERFACE}: CTRL-EVENT-CONNECTED" ${WPA_OUTFILE}; do
        :
    done
    sleep 0.5
    dhclient -d ${INTERFACE}
    kill_things
    echo 'Restarting...' 1>&2
done
